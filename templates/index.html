from flask import Flask, render_template, request, jsonify
import wikipedia
import re

app = Flask(__name__)

# Improve search filtering
def get_clean_summary(query):
    try:
        wikipedia.set_lang("en")
        
        # Handle case where user sends random word like "yoo"
        if len(query.strip()) < 3 or query.lower() in ["you", "me", "he", "she", "yoo", "yeah"]:
            return "Could you please clarify your question a bit more?"

        # Try direct summary
        summary = wikipedia.summary(query, sentences=2, auto_suggest=False, redirect=True)
        
        # Ignore too short or weird summaries
        if len(summary.split()) < 10 or 'may refer to' in summary.lower():
            raise ValueError("Too vague")

        return summary

    except Exception:
        try:
            # Try search suggestions
            search_results = wikipedia.search(query)
            for result in search_results:
                if query.lower() in result.lower():
                    try:
                        summary = wikipedia.summary(result, sentences=2)
                        if len(summary.split()) > 10 and "may refer to" not in summary.lower():
                            return summary
                    except:
                        continue
            return "I couldn't find an accurate answer for that. Could you rephrase it?"
        except:
            return "I'm having trouble understanding that. Try asking in a different way."

@app.route('/')
def index():
    return render_template('index.html')

@app.route('/chat', methods=['POST'])
def chat():
    user_msg = request.json.get('message', '').strip()

    if not user_msg:
        return jsonify({'reply': "Please type something!"})

    # Lowercase version for trigger matching
    lower_msg = user_msg.lower()

    # Greeting triggers
    greetings = ['hi', 'hello', 'hey', 'good morning', 'good evening']
    if any(word in lower_msg for word in greetings):
        return jsonify({'reply': "Hello! I'm Kris AI. How can I assist you today?"})

    # Wikipedia question triggers
    triggers = [
        'tell me about', 'who is', 'what is', 'what are', 'give me information about',
        'i want to know about', 'do you know about', 'please explain', 'could you explain',
        'details about', 'information on', 'whats the', "what's the", "whats", "what's"
    ]

    # Check if message contains a trigger
    if any(trigger in lower_msg for trigger in triggers) or '?' in user_msg:
        cleaned = re.sub(r'[^\w\s]', '', user_msg)  # Remove punctuation
        return jsonify({'reply': get_clean_summary(cleaned)})

    # Default fallback
    return jsonify({'reply': "Interesting! Let me know if you have a question or need information on something."})

if __name__ == '__main__':
    app.run(debug=True)